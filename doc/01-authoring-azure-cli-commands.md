# Manually Generating Azure CLI Commands using AutoRest AZ

>NOTE: **autorest.az** is currently under development and tooling is not functional yet.

This document describes generation of Azure CLI Commands using **autorest.az**.

## Prepare Your Environment

Install AutoRest tools, or alternatively you can use Docker container.

You will need to clone following directories locally.

    git clone https://github.com/Azure/azure-rest-api-specs
    git clone https://github.com/Azure/azure-cli-extensions.git

For simplicity let's assume they are cloned under **c:\dev** directory on Windows machine.

>NOTE: Released Azure CLI doesn't have support for Azure Core, so use following procedure to test autogenerated extensions. 
>
> Clone Azure CLI:
>
> git clone https://github.com/Azure/azure-cli.git
>
> switch to **azure_core** branch.
>
> Set up your environment using **azdev setup**.

### Using the Container

    docker run -it --rm -v c:\dev:/_ mcr.microsoft.com/azure-cli/tools

### Setup Environment Manually

>NOTE: This may be extremely useful for development purposes as **--interactive** option is available only in Windows environment

Things that need to be installed:
- Node JS (check version etc, instructions)
- Python (check version etc, instructions)
- Autorest Beta (instructions)
- Tools needed to test extensions...

## Run AutoRest to Generate Azure CLI Extensions

### Command to Run AutoRest

    autorest --az --version=3.0.6212 --output-folder=/_/azure-cli-extensions /_/azure-rest-api-specs/specification/attestation/resource-manager/readme.md

When you run above command AutoRest will download and use most recent npm packages.

### Command to Run AutoRest with clicommon/az Extensions as Source Code

If you want to run **az** using your local code you need to clone following repositories:



    ...

### Prepare Minimal **readme.az.md** and **readme.cli.md** File

Minimal **readme.cli.md** file must exist: 

    ## CLI

    These settings apply only when `--az` is specified on the command line.

    ``` yaml $(cli)
    cli:
      namespace: azure.mgmt.healthcareapis
    ```

### Python SDK

Python SDK will be automatically generated, however appropriate folder needs to be specified.
Add following line to **readme.az.md**:


    ``` yaml $(az)
    az:
      ...
      python-sdk-output-folder: "$(output-folder)/src/<extension-name>/azext_<extension-name>/vendored_sdks/<sdk-namespace-name>"
    ```

NOTE: In the future this step may be automated, but for now it's necessary it matches extension folder structure.

### Integration Test

When generating your extension **autorest.cli** will attempt to create default integration test. You may see output as follows:

    WARNING:
    WARNING: NO TEST SCENARIO PROVIDED - DEFAULT WILL BE USED
    WARNING: ADD FOLLOWING SECTION TO readme.cli.md FILE TO MODIFY IT
    WARNING: --------------------------------------------------------
    WARNING:   test-scenario:
    WARNING:     - name: PutActionRule
    WARNING:     - name: Create or update a Smart Detector alert rule
    WARNING:     - name: Get a Smart Detector alert rule
    WARNING:     - name: GetActionRuleById
    WARNING:     - name: List alert rules
    WARNING:     - name: GetActionRulesResourceGroupWide
    WARNING:     - name: Resolve
    WARNING:     - name: Get
    WARNING:     - name: Resolve
    WARNING:     - name: List Smart Detector alert rules
    WARNING:     - name: GetById
    WARNING:     - name: Summary
    WARNING:     - name: List
    WARNING:     - name: GetActionRulesSubscriptionWide
    WARNING:     - name: ListAlerts
    WARNING:     - name: MonService
    WARNING:     - name: Patch alert rules
    WARNING:     - name: PatchActionRule
    WARNING:     - name: changestate
    WARNING:     - name: Resolve
    WARNING:     - name: Delete a Smart Detector alert rule
    WARNING:     - name: DeleteActionRule
    WARNING: --------------------------------------------------------

There are some rules used:
- all create methods are on the top
- followed by update methods
- followed by methods performing actions
- then all get/list examples are appended
- finally all delete examples
- in addition method URL length is used to determine dependencies

Despite that effort generated test scenario may be not correct. It may need some additional work:
- fixing examples in swagger
- changing sequence of tests
- disabling some of the examples
- adding prerequisites

It is advised to resolve all the test issues before actually generating the extension itself.

## Running The Extension

To install the extension run:

    azdev extension add <your-extension-name>

Then you can verify that extension was installed correctly by running:

    az <your-extension-name> --help

and proceed with:

    az login

and testing all the examples.

## Running Integration Test

Start with:

    az login

then

    azdev test --live --discover <extension-name>

## Publishing Extension

To publish an extension (assuming you did **az login** already):

azdev extension publish <extension-name> --storage-account <storage-account-name> --update-index --storage-container <storage-container-name> --storage-subscription <subscription-id>

After doing that, following things will happen:
- package will be built
- package will be pushed to storage account
- **index.json** file will be updated

At this point you can commit and push the change to **index.json**.

>NOTE 1: Extension won't be published until PR is merged into master branch

>NOTE 2: When running **azdev extension publish** old entry won't be removed so it may be necessary to remove it manually

>NOTE 3: Adding extension to index triggers some additional sanity checks and there may be additional errors to fix, so it advised to add extension to index as soon as possible.
